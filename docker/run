#!/bin/bash
# Consolidated run script for Skewed Emacs Docker container

# Default values
IMAGE_TAG="dev"
CONTAINER_NAME="skewed-emacs"
HTTP_PORT="7081"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -t|--tag)
      IMAGE_TAG="$2"
      shift 2
      ;;
    -n|--name)
      CONTAINER_NAME="$2"
      shift 2
      ;;
    -p|--port)
      HTTP_PORT="$2"
      shift 2
      ;;
    -h|--help)
      echo "Usage: $0 [OPTIONS]"
      echo "Options:"
      echo "  -t, --tag TAG           Image tag to run (default: dev)"
      echo "  -n, --name NAME         Container name (default: skewed-emacs)"
      echo "  -p, --port PORT         Host port for HTTP API (default: 7081)"
      echo "  -h, --help              Show this help message"
      echo ""
      echo "The container will:"
      echo "  - Mount ~/projects as /projects (read-only if ~/projects doesn't exist)"
      echo "  - Present a clean Emacs Lisp REPL on stdin/stdout"
      echo "  - Start HTTP API on specified port"
      echo "  - Have no access to other host filesystem directories"
      exit 0
      ;;
    *)
      echo "Unknown option $1"
      exit 1
      ;;
  esac
done

# Stop and remove existing container if it exists
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Stopping and removing existing container: ${CONTAINER_NAME}"
    docker stop ${CONTAINER_NAME} 2>/dev/null || true
    docker rm ${CONTAINER_NAME} 2>/dev/null || true
fi

echo "Starting Skewed Emacs container..."
echo "  Image: skewed-emacs:${IMAGE_TAG}"
echo "  Container name: ${CONTAINER_NAME}"
echo "  HTTP API: localhost:${HTTP_PORT}"

# Check if ~/projects exists and set up mount accordingly
MOUNT_OPTIONS=""
if [ -d "$HOME/projects" ]; then
    echo "  Projects mount: $HOME/projects -> /projects"
    MOUNT_OPTIONS="-v $HOME/projects:/projects"
else
    echo "  Projects mount: /projects (empty directory - ~/projects not found)"
fi

# Run the container with projects mount and interactive terminal
docker run -it --rm \
    --name ${CONTAINER_NAME} \
    -p ${HTTP_PORT}:7080 \
    ${MOUNT_OPTIONS} \
    skewed-emacs:${IMAGE_TAG}

echo "Container exited."
